{"version":3,"sources":["../../../src/core/DatabaseManager.ts"],"sourcesContent":["/**\n * DatabaseManager - Manages SQLite and JSON fallback storage\n * Provides a unified interface for persistent data storage with automatic fallback\n */\n\nimport * as fs from 'fs-extra';\nimport * as path from 'path';\nimport { IDatabaseProvider } from '../types/interfaces.js';\nimport { isNativeModuleVersionError, getNativeModuleRecoveryMessage } from '../utils/error-recovery.js';\n\n/**\n * Custom error class for native module issues\n */\nexport class NativeModuleError extends Error {\n  public readonly originalError: Error;\n  public readonly isNativeModuleError = true;\n\n  constructor(message: string, originalError: Error) {\n    super(message);\n    this.name = 'NativeModuleError';\n    this.originalError = originalError;\n  }\n}\n\nexport class DatabaseManager implements IDatabaseProvider {\n  private provider: IDatabaseProvider;\n  private dbType: 'sqlite' | 'json';\n  private dbPath: string;\n  private initialized: boolean = false;\n  private retryCount: number = 0;\n  private maxRetries: number = 3;\n\n  constructor(dbType: 'sqlite' | 'json' = 'sqlite', dbPath?: string) {\n    this.dbType = dbType;\n    this.dbPath = dbPath || this.getDefaultPath();\n\n    // Try SQLite first, fallback to JSON if needed\n    if (this.dbType === 'sqlite') {\n      this.provider = this.initializeSQLiteWithRecovery();\n    } else {\n      this.provider = new JSONProvider(this.dbPath);\n    }\n  }\n\n  /**\n   * Initialize SQLite with automatic error recovery\n   */\n  private initializeSQLiteWithRecovery(): IDatabaseProvider {\n    try {\n      return new SQLiteProvider(this.dbPath);\n    } catch (error) {\n      const errorMsg = error instanceof Error ? error.message : String(error);\n\n      // Check for native module version mismatch (NODE_MODULE_VERSION error)\n      if (error instanceof NativeModuleError || isNativeModuleVersionError(error)) {\n        console.warn('\\n' + (error instanceof NativeModuleError ? error.message : getNativeModuleRecoveryMessage(error)));\n        console.warn('   Falling back to JSON storage (no data loss, just slower).\\n');\n      }\n      // Check if it's an npm cache error\n      else if (errorMsg.includes('ENOTEMPTY') || errorMsg.includes('better-sqlite3')) {\n        console.warn('‚ö†Ô∏è  SQLite initialization failed due to npm cache error');\n        console.warn('   Will attempt automatic recovery during initialize()');\n      } else {\n        console.warn('SQLite not available, falling back to JSON storage:', errorMsg);\n      }\n\n      // Fallback to JSON for now\n      this.provider = new JSONProvider(this.dbPath.replace('.sqlite', '.json'));\n      this.dbType = 'json';\n      return this.provider;\n    }\n  }\n\n  private getDefaultPath(): string {\n    const baseDir = path.join(process.cwd(), '.claude-flow');\n    return this.dbType === 'sqlite'\n      ? path.join(baseDir, 'database.sqlite')\n      : path.join(baseDir, 'database.json');\n  }\n\n  async initialize(): Promise<void> {\n    await fs.ensureDir(path.dirname(this.dbPath));\n\n    try {\n      await this.provider.initialize();\n      this.initialized = true;\n    } catch (error) {\n      // If JSON provider failed, just propagate the error\n      if (this.dbType === 'json') {\n        throw error;\n      }\n\n      // For SQLite errors, attempt recovery\n      const errorMsg = error instanceof Error ? error.message : String(error);\n      if (this.retryCount < this.maxRetries) {\n        console.warn(`‚ö†Ô∏è  Database initialization failed (attempt ${this.retryCount + 1}/${this.maxRetries})`);\n        console.warn(`   Error: ${errorMsg}`);\n\n        // Attempt to recover by switching to JSON\n        console.log('üîÑ Switching to JSON storage as fallback...');\n        this.provider = new JSONProvider(this.dbPath.replace('.sqlite', '.json'));\n        this.dbType = 'json';\n        this.retryCount++;\n\n        // Retry initialization with JSON provider\n        await this.initialize();\n      } else {\n        throw error;\n      }\n    }\n  }\n\n  async store(key: string, value: any, namespace: string = 'default'): Promise<void> {\n    if (!this.initialized) {\n      await this.initialize();\n    }\n    return this.provider.store(key, value, namespace);\n  }\n\n  async retrieve(key: string, namespace: string = 'default'): Promise<any> {\n    if (!this.initialized) {\n      await this.initialize();\n    }\n    return this.provider.retrieve(key, namespace);\n  }\n\n  async delete(key: string, namespace: string = 'default'): Promise<boolean> {\n    if (!this.initialized) {\n      await this.initialize();\n    }\n    return this.provider.delete(key, namespace);\n  }\n\n  async list(namespace: string = 'default'): Promise<string[]> {\n    if (!this.initialized) {\n      await this.initialize();\n    }\n    return this.provider.list(namespace);\n  }\n\n  async close(): Promise<void> {\n    if (this.provider) {\n      await this.provider.close();\n    }\n    this.initialized = false;\n  }\n\n  getDatabaseType(): 'sqlite' | 'json' {\n    return this.dbType;\n  }\n\n  getDatabasePath(): string {\n    return this.dbPath;\n  }\n\n  isInitialized(): boolean {\n    return this.initialized;\n  }\n\n  // Specialized methods for common operations\n  async storeJSON(key: string, data: object, namespace?: string): Promise<void> {\n    await this.store(key, JSON.stringify(data), namespace);\n  }\n\n  async retrieveJSON(key: string, namespace?: string): Promise<object | null> {\n    const data = await this.retrieve(key, namespace);\n    if (!data) return null;\n    try {\n      return typeof data === 'string' ? JSON.parse(data) : data;\n    } catch {\n      return null;\n    }\n  }\n\n  async exists(key: string, namespace?: string): Promise<boolean> {\n    const data = await this.retrieve(key, namespace);\n    return data !== null && data !== undefined;\n  }\n\n  async clear(namespace?: string): Promise<void> {\n    const keys = await this.list(namespace);\n    await Promise.all(keys.map(key => this.delete(key, namespace)));\n  }\n}\n\n/**\n * SQLite implementation\n */\nclass SQLiteProvider implements IDatabaseProvider {\n  private db: any;\n  private dbPath: string;\n\n  constructor(dbPath: string) {\n    this.dbPath = dbPath;\n    // Dynamic import to handle optional dependency\n    try {\n      const Database = require('better-sqlite3');\n      this.db = new Database(dbPath);\n    } catch (error) {\n      // Check for native module version mismatch (NODE_MODULE_VERSION error)\n      if (isNativeModuleVersionError(error)) {\n        const recoveryMsg = getNativeModuleRecoveryMessage(error);\n        throw new NativeModuleError(recoveryMsg, error as Error);\n      }\n      throw new Error('better-sqlite3 not available. Install with: npm install better-sqlite3');\n    }\n  }\n\n  async initialize(): Promise<void> {\n    // Create tables\n    this.db.exec(`\n      CREATE TABLE IF NOT EXISTS storage (\n        namespace TEXT NOT NULL,\n        key TEXT NOT NULL,\n        value TEXT NOT NULL,\n        created_at INTEGER DEFAULT (strftime('%s', 'now')),\n        updated_at INTEGER DEFAULT (strftime('%s', 'now')),\n        PRIMARY KEY (namespace, key)\n      )\n    `);\n\n    this.db.exec(`\n      CREATE INDEX IF NOT EXISTS idx_storage_namespace ON storage(namespace);\n      CREATE INDEX IF NOT EXISTS idx_storage_created_at ON storage(created_at);\n    `);\n  }\n\n  async store(key: string, value: any, namespace: string = 'default'): Promise<void> {\n    const stmt = this.db.prepare(`\n      INSERT OR REPLACE INTO storage (namespace, key, value, updated_at)\n      VALUES (?, ?, ?, strftime('%s', 'now'))\n    `);\n\n    const serializedValue = typeof value === 'string' ? value : JSON.stringify(value);\n    stmt.run(namespace, key, serializedValue);\n  }\n\n  async retrieve(key: string, namespace: string = 'default'): Promise<any> {\n    const stmt = this.db.prepare('SELECT value FROM storage WHERE namespace = ? AND key = ?');\n    const row = stmt.get(namespace, key);\n\n    if (!row) return null;\n\n    try {\n      return JSON.parse(row.value);\n    } catch {\n      return row.value;\n    }\n  }\n\n  async delete(key: string, namespace: string = 'default'): Promise<boolean> {\n    const stmt = this.db.prepare('DELETE FROM storage WHERE namespace = ? AND key = ?');\n    const result = stmt.run(namespace, key);\n    return result.changes > 0;\n  }\n\n  async list(namespace: string = 'default'): Promise<string[]> {\n    const stmt = this.db.prepare('SELECT key FROM storage WHERE namespace = ? ORDER BY key');\n    const rows = stmt.all(namespace);\n    return rows.map((row: any) => row.key);\n  }\n\n  async close(): Promise<void> {\n    if (this.db) {\n      this.db.close();\n    }\n  }\n}\n\n/**\n * JSON file-based implementation\n */\nclass JSONProvider implements IDatabaseProvider {\n  private data: Record<string, Record<string, any>> = {};\n  private dbPath: string;\n\n  constructor(dbPath: string) {\n    this.dbPath = dbPath;\n  }\n\n  async initialize(): Promise<void> {\n    try {\n      if (await fs.pathExists(this.dbPath)) {\n        const content = await fs.readJSON(this.dbPath);\n        this.data = content || {};\n      }\n    } catch (error) {\n      console.warn('Failed to load JSON database, starting fresh:', error);\n      this.data = {};\n    }\n  }\n\n  async store(key: string, value: any, namespace: string = 'default'): Promise<void> {\n    if (!this.data[namespace]) {\n      this.data[namespace] = {};\n    }\n\n    this.data[namespace][key] = value;\n    await this.persist();\n  }\n\n  async retrieve(key: string, namespace: string = 'default'): Promise<any> {\n    if (!this.data[namespace]) {\n      return null;\n    }\n    return this.data[namespace][key] || null;\n  }\n\n  async delete(key: string, namespace: string = 'default'): Promise<boolean> {\n    if (!this.data[namespace] || !(key in this.data[namespace])) {\n      return false;\n    }\n\n    delete this.data[namespace][key];\n    await this.persist();\n    return true;\n  }\n\n  async list(namespace: string = 'default'): Promise<string[]> {\n    if (!this.data[namespace]) {\n      return [];\n    }\n    return Object.keys(this.data[namespace]).sort();\n  }\n\n  async close(): Promise<void> {\n    await this.persist();\n  }\n\n  private async persist(): Promise<void> {\n    try {\n      await fs.ensureDir(path.dirname(this.dbPath));\n      await fs.writeJSON(this.dbPath, this.data, { spaces: 2 });\n    } catch (error) {\n      console.error('Failed to persist JSON database:', error);\n    }\n  }\n}"],"names":["fs","path","isNativeModuleVersionError","getNativeModuleRecoveryMessage","NativeModuleError","Error","originalError","isNativeModuleError","message","name","DatabaseManager","provider","dbType","dbPath","initialized","retryCount","maxRetries","getDefaultPath","initializeSQLiteWithRecovery","JSONProvider","SQLiteProvider","error","errorMsg","String","console","warn","includes","replace","baseDir","join","process","cwd","initialize","ensureDir","dirname","log","store","key","value","namespace","retrieve","delete","list","close","getDatabaseType","getDatabasePath","isInitialized","storeJSON","data","JSON","stringify","retrieveJSON","parse","exists","undefined","clear","keys","Promise","all","map","db","Database","require","recoveryMsg","exec","stmt","prepare","serializedValue","run","row","get","result","changes","rows","pathExists","content","readJSON","persist","Object","sort","writeJSON","spaces"],"mappings":"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"}