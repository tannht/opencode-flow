{"version":3,"sources":["../../../../src/mcp/validation/schema-validator-2025.ts"],"sourcesContent":["/**\n * JSON Schema 1.1 Validator for MCP 2025-11\n *\n * Implements comprehensive schema validation per MCP 2025-11 specification\n * using JSON Schema Draft 2020-12\n */\n\nimport Ajv, { type ErrorObject } from 'ajv';\nimport addFormats from 'ajv-formats';\nimport addErrors from 'ajv-errors';\nimport type { ILogger } from '../../interfaces/logger.js';\n\n/**\n * Validation result\n */\nexport interface ValidationResult {\n  valid: boolean;\n  errors?: Array<{\n    path: string;\n    message: string;\n    params?: any;\n  }>;\n}\n\n/**\n * Schema cache entry\n */\ninterface CachedSchema {\n  schema: object;\n  validate: any;\n  timestamp: number;\n}\n\n/**\n * MCP 2025-11 JSON Schema Validator\n *\n * Features:\n * - JSON Schema Draft 2020-12 support\n * - Format validation (uri, email, date-time, etc.)\n * - Schema caching for performance\n * - Custom error messages\n * - $ref support\n */\nexport class SchemaValidator {\n  private ajv: Ajv;\n  private schemaCache: Map<string, CachedSchema> = new Map();\n  private cacheTTL = 3600000; // 1 hour\n  private readonly MAX_CACHE_SIZE = 1000; // Maximum cached schemas\n\n  constructor(private logger: ILogger) {\n    this.ajv = new Ajv({\n      allErrors: true,\n      strict: true,\n      validateFormats: true,\n      allowUnionTypes: true,\n      // Support JSON Schema Draft 2020-12\n      schemaId: 'auto',\n    });\n\n    // Add format validators (email, uri, date-time, etc.)\n    addFormats(this.ajv);\n\n    // Add custom error messages support\n    addErrors(this.ajv);\n\n    this.logger.info('Schema validator initialized', {\n      draft: '2020-12',\n      formats: 'enabled',\n    });\n  }\n\n  /**\n   * Validate input against JSON Schema 1.1\n   */\n  validateInput(schema: object, input: unknown): ValidationResult {\n    try {\n      const validate = this.getValidator(schema);\n      const valid = validate(input);\n\n      if (!valid && validate.errors) {\n        return {\n          valid: false,\n          errors: this.formatErrors(validate.errors),\n        };\n      }\n\n      return { valid: true };\n    } catch (error) {\n      this.logger.error('Schema validation error', {\n        error: error instanceof Error ? error.message : String(error),\n      });\n\n      return {\n        valid: false,\n        errors: [{\n          path: '',\n          message: 'Schema validation failed',\n        }],\n      };\n    }\n  }\n\n  /**\n   * Validate output against schema\n   */\n  validateOutput(schema: object, output: unknown): ValidationResult {\n    return this.validateInput(schema, output);\n  }\n\n  /**\n   * Validate tool schema itself\n   */\n  validateToolSchema(toolSchema: object): ValidationResult {\n    // Ensure schema has required fields\n    const requiredFields = ['$schema', 'type', 'properties'];\n    const schemaObj = toolSchema as any;\n\n    const missing = requiredFields.filter(field => !(field in schemaObj));\n    if (missing.length > 0) {\n      return {\n        valid: false,\n        errors: missing.map(field => ({\n          path: '/',\n          message: `Missing required field: ${field}`,\n        })),\n      };\n    }\n\n    // Validate schema is valid JSON Schema\n    try {\n      this.ajv.compile(toolSchema);\n      return { valid: true };\n    } catch (error) {\n      return {\n        valid: false,\n        errors: [{\n          path: '/',\n          message: error instanceof Error ? error.message : 'Invalid schema',\n        }],\n      };\n    }\n  }\n\n  /**\n   * Get or create validator for schema\n   */\n  private getValidator(schema: object): any {\n    const schemaKey = JSON.stringify(schema);\n    const cached = this.schemaCache.get(schemaKey);\n\n    // Return cached validator if still valid\n    if (cached && Date.now() - cached.timestamp < this.cacheTTL) {\n      return cached.validate;\n    }\n\n    // Compile new validator\n    try {\n      const validate = this.ajv.compile(schema);\n\n      // Enforce cache size limit (LRU eviction - remove oldest entry)\n      if (this.schemaCache.size >= this.MAX_CACHE_SIZE) {\n        const oldest = Array.from(this.schemaCache.entries())\n          .sort((a, b) => a[1].timestamp - b[1].timestamp)[0];\n\n        if (oldest) {\n          this.schemaCache.delete(oldest[0]);\n          this.logger.debug('Evicted oldest schema from cache', {\n            cacheSize: this.schemaCache.size,\n            maxSize: this.MAX_CACHE_SIZE,\n          });\n        }\n      }\n\n      // Cache for future use\n      this.schemaCache.set(schemaKey, {\n        schema,\n        validate,\n        timestamp: Date.now(),\n      });\n\n      return validate;\n    } catch (error) {\n      this.logger.error('Failed to compile schema', {\n        error: error instanceof Error ? error.message : String(error),\n      });\n      throw error;\n    }\n  }\n\n  /**\n   * Format ajv errors to user-friendly format\n   */\n  private formatErrors(errors: ErrorObject[]): ValidationResult['errors'] {\n    return errors.map(err => ({\n      path: err.instancePath || '/',\n      message: this.getErrorMessage(err),\n      params: err.params,\n    }));\n  }\n\n  /**\n   * Get user-friendly error message\n   */\n  private getErrorMessage(error: ErrorObject): string {\n    const { keyword, message, params } = error;\n\n    switch (keyword) {\n      case 'required':\n        return `Missing required property: ${params.missingProperty}`;\n      case 'type':\n        return `Expected ${params.type} but got ${typeof params.data}`;\n      case 'format':\n        return `Invalid format for ${params.format}`;\n      case 'minimum':\n        return `Value must be >= ${params.limit}`;\n      case 'maximum':\n        return `Value must be <= ${params.limit}`;\n      case 'minLength':\n        return `String must be at least ${params.limit} characters`;\n      case 'maxLength':\n        return `String must be at most ${params.limit} characters`;\n      case 'pattern':\n        return `String must match pattern: ${params.pattern}`;\n      case 'enum':\n        return `Value must be one of: ${params.allowedValues?.join(', ')}`;\n      default:\n        return message || `Validation failed: ${keyword}`;\n    }\n  }\n\n  /**\n   * Clear schema cache\n   */\n  clearCache(): void {\n    this.schemaCache.clear();\n    this.logger.info('Schema cache cleared');\n  }\n\n  /**\n   * Get cache statistics\n   */\n  getCacheStats() {\n    return {\n      size: this.schemaCache.size,\n      entries: Array.from(this.schemaCache.values()).map(entry => ({\n        age: Date.now() - entry.timestamp,\n        expired: Date.now() - entry.timestamp > this.cacheTTL,\n      })),\n    };\n  }\n\n  /**\n   * Cleanup expired cache entries\n   */\n  cleanupCache(): number {\n    const now = Date.now();\n    let cleaned = 0;\n\n    for (const [key, entry] of this.schemaCache.entries()) {\n      if (now - entry.timestamp > this.cacheTTL) {\n        this.schemaCache.delete(key);\n        cleaned++;\n      }\n    }\n\n    if (cleaned > 0) {\n      this.logger.info('Cleaned up expired schema cache entries', { count: cleaned });\n    }\n\n    return cleaned;\n  }\n}\n\n/**\n * Convert legacy tool schema to MCP 2025-11 format\n */\nexport function upgradeToolSchema(legacySchema: any): object {\n  // If already in 2025-11 format, return as-is\n  if (legacySchema.$schema && legacySchema.$schema.includes('2020-12')) {\n    return legacySchema;\n  }\n\n  // Convert to 2025-11 format\n  return {\n    $schema: 'https://json-schema.org/draft/2020-12/schema',\n    type: legacySchema.type || 'object',\n    properties: legacySchema.properties || {},\n    required: legacySchema.required || [],\n    additionalProperties: legacySchema.additionalProperties !== undefined\n      ? legacySchema.additionalProperties\n      : false,\n    description: legacySchema.description,\n  };\n}\n"],"names":["Ajv","addFormats","addErrors","SchemaValidator","ajv","schemaCache","Map","cacheTTL","MAX_CACHE_SIZE","logger","allErrors","strict","validateFormats","allowUnionTypes","schemaId","info","draft","formats","validateInput","schema","input","validate","getValidator","valid","errors","formatErrors","error","Error","message","String","path","validateOutput","output","validateToolSchema","toolSchema","requiredFields","schemaObj","missing","filter","field","length","map","compile","schemaKey","JSON","stringify","cached","get","Date","now","timestamp","size","oldest","Array","from","entries","sort","a","b","delete","debug","cacheSize","maxSize","set","err","instancePath","getErrorMessage","params","keyword","missingProperty","type","data","format","limit","pattern","allowedValues","join","clearCache","clear","getCacheStats","values","entry","age","expired","cleanupCache","cleaned","key","count","upgradeToolSchema","legacySchema","$schema","includes","properties","required","additionalProperties","undefined","description"],"mappings":"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"}