{"version":3,"sources":["../../../src/utils/error-recovery.ts"],"sourcesContent":["/**\n * Error Recovery Utilities\n * Automatic error detection and recovery for common installation issues\n */\n\nimport { execSync } from 'child_process';\nimport * as fs from 'fs-extra';\nimport * as path from 'path';\nimport * as os from 'os';\n\nexport interface RecoveryResult {\n  success: boolean;\n  action: string;\n  message: string;\n  recovered: boolean;\n}\n\nexport interface RetryOptions {\n  maxRetries?: number;\n  delay?: number;\n  onRetry?: (attempt: number, error: Error) => void;\n  cleanupFn?: () => Promise<void>;\n}\n\n/**\n * Detect if an error is the ENOTEMPTY npm cache error\n */\nexport function isNpmCacheError(error: any): boolean {\n  const errorStr = error?.message || String(error);\n  return (\n    errorStr.includes('ENOTEMPTY') &&\n    (errorStr.includes('npm') || errorStr.includes('npx') || errorStr.includes('_npx'))\n  ) || errorStr.includes('better-sqlite3');\n}\n\n/**\n * Detect if an error is a native module version mismatch (NODE_MODULE_VERSION)\n * This happens when native modules are compiled for a different Node.js version\n */\nexport function isNativeModuleVersionError(error: any): boolean {\n  const errorStr = error?.message || String(error);\n  return (\n    errorStr.includes('NODE_MODULE_VERSION') ||\n    errorStr.includes('was compiled against a different Node.js version') ||\n    errorStr.includes('re-compiling or re-installing the module')\n  );\n}\n\n/**\n * Get helpful message for native module version mismatch\n */\nexport function getNativeModuleRecoveryMessage(error: any): string {\n  const errorStr = error?.message || String(error);\n\n  // Extract version numbers if available\n  const compiledMatch = errorStr.match(/NODE_MODULE_VERSION (\\d+)/);\n  const requiredMatch = errorStr.match(/requires\\s+NODE_MODULE_VERSION (\\d+)/);\n\n  let message = '‚ö†Ô∏è  Native module version mismatch detected.\\n';\n\n  if (compiledMatch && requiredMatch) {\n    const nodeVersionMap: Record<string, string> = {\n      '108': '18.x',\n      '115': '20.x',\n      '120': '21.x',\n      '127': '22.x',\n      '131': '23.x'\n    };\n    const compiled = nodeVersionMap[compiledMatch[1]] || `ABI ${compiledMatch[1]}`;\n    const required = nodeVersionMap[requiredMatch[1]] || `ABI ${requiredMatch[1]}`;\n    message += `   Module was compiled for Node.js ${compiled}, but running Node.js ${required}.\\n`;\n  }\n\n  message += '\\n   To fix this, try one of:\\n';\n  message += '   1. npm rebuild better-sqlite3\\n';\n  message += '   2. rm -rf node_modules && npm install\\n';\n  message += '   3. npx cache: rm -rf ~/.npm/_npx/ && run command again\\n';\n\n  return message;\n}\n\n/**\n * Detect if running on WSL (Windows Subsystem for Linux)\n */\nexport function isWSL(): boolean {\n  if (process.platform !== 'linux') {\n    return false;\n  }\n\n  try {\n    const release = fs.readFileSync('/proc/version', 'utf8').toLowerCase();\n    return release.includes('microsoft') || release.includes('wsl');\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Clean npm and npx cache directories\n */\nexport async function cleanNpmCache(): Promise<RecoveryResult> {\n  const homeDir = os.homedir();\n  const npxCacheDir = path.join(homeDir, '.npm', '_npx');\n\n  try {\n    console.log('üßπ Cleaning npm cache...');\n\n    // Clean npm cache\n    try {\n      execSync('npm cache clean --force', { stdio: 'pipe' });\n      console.log('‚úÖ npm cache cleaned');\n    } catch (error) {\n      console.warn('‚ö†Ô∏è  npm cache clean failed, continuing...');\n    }\n\n    // Remove npx cache directory\n    if (await fs.pathExists(npxCacheDir)) {\n      console.log(`üóëÔ∏è  Removing npx cache: ${npxCacheDir}`);\n      await fs.remove(npxCacheDir);\n      console.log('‚úÖ npx cache removed');\n    }\n\n    // Fix permissions on WSL\n    if (isWSL()) {\n      const npmDir = path.join(homeDir, '.npm');\n      if (await fs.pathExists(npmDir)) {\n        try {\n          execSync(`chmod -R 755 \"${npmDir}\"`, { stdio: 'pipe' });\n          console.log('‚úÖ npm directory permissions fixed');\n        } catch (error) {\n          console.warn('‚ö†Ô∏è  Permission fix failed, continuing...');\n        }\n      }\n    }\n\n    return {\n      success: true,\n      action: 'cache-cleanup',\n      message: 'npm/npx cache cleaned successfully',\n      recovered: true\n    };\n  } catch (error) {\n    return {\n      success: false,\n      action: 'cache-cleanup',\n      message: `Failed to clean cache: ${error instanceof Error ? error.message : String(error)}`,\n      recovered: false\n    };\n  }\n}\n\n/**\n * Automatic retry with exponential backoff and error recovery\n */\nexport async function retryWithRecovery<T>(\n  fn: () => Promise<T>,\n  options: RetryOptions = {}\n): Promise<T> {\n  const {\n    maxRetries = 3,\n    delay = 1000,\n    onRetry,\n    cleanupFn\n  } = options;\n\n  let lastError: Error | undefined;\n\n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\n    try {\n      return await fn();\n    } catch (error) {\n      lastError = error as Error;\n\n      // Check if it's a recoverable error\n      if (isNpmCacheError(error)) {\n        console.log(`\\n‚ö†Ô∏è  Detected npm cache error (attempt ${attempt}/${maxRetries})`);\n\n        // Attempt automatic recovery\n        const recovery = await cleanNpmCache();\n        if (recovery.success) {\n          console.log('‚úÖ Cache cleaned, retrying...\\n');\n\n          // Run custom cleanup if provided\n          if (cleanupFn) {\n            await cleanupFn();\n          }\n\n          // Exponential backoff\n          const backoffDelay = delay * Math.pow(2, attempt - 1);\n          await new Promise(resolve => setTimeout(resolve, backoffDelay));\n\n          continue; // Retry\n        } else {\n          console.error('‚ùå Cache cleanup failed:', recovery.message);\n        }\n      }\n\n      // Call retry callback\n      if (onRetry && attempt < maxRetries) {\n        onRetry(attempt, lastError);\n        await new Promise(resolve => setTimeout(resolve, delay));\n        continue;\n      }\n\n      // Last attempt failed\n      if (attempt === maxRetries) {\n        break;\n      }\n    }\n  }\n\n  // All retries exhausted\n  throw new Error(\n    `Operation failed after ${maxRetries} attempts. ` +\n    `Last error: ${lastError?.message || 'Unknown error'}`\n  );\n}\n\n/**\n * WSL-specific error recovery\n */\nexport async function recoverWSLErrors(): Promise<RecoveryResult> {\n  if (!isWSL()) {\n    return {\n      success: true,\n      action: 'wsl-check',\n      message: 'Not running on WSL, no recovery needed',\n      recovered: false\n    };\n  }\n\n  console.log('üîç Detected WSL environment, applying fixes...');\n\n  try {\n    const homeDir = os.homedir();\n\n    // Check if running from Windows mount\n    const cwd = process.cwd();\n    if (cwd.startsWith('/mnt/')) {\n      console.warn('‚ö†Ô∏è  WARNING: Running from Windows filesystem (/mnt/)');\n      console.warn('   For best results, run from WSL filesystem (e.g., ~/projects/)');\n    }\n\n    // Ensure build tools are available\n    try {\n      execSync('which gcc', { stdio: 'pipe' });\n    } catch {\n      console.warn('‚ö†Ô∏è  build-essential not found. Install with:');\n      console.warn('   sudo apt-get update && sudo apt-get install -y build-essential python3');\n    }\n\n    // Clean cache with WSL-specific handling\n    return await cleanNpmCache();\n  } catch (error) {\n    return {\n      success: false,\n      action: 'wsl-recovery',\n      message: `WSL recovery failed: ${error instanceof Error ? error.message : String(error)}`,\n      recovered: false\n    };\n  }\n}\n\n/**\n * Verify better-sqlite3 installation\n */\nexport async function verifyBetterSqlite3(): Promise<boolean> {\n  try {\n    require.resolve('better-sqlite3');\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Install better-sqlite3 with retry and error recovery\n */\nexport async function installBetterSqlite3WithRecovery(): Promise<RecoveryResult> {\n  console.log('üì¶ Installing better-sqlite3...');\n\n  return retryWithRecovery(\n    async () => {\n      execSync('npm install better-sqlite3 --no-save', {\n        stdio: 'inherit',\n        cwd: process.cwd()\n      });\n\n      // Verify installation\n      if (await verifyBetterSqlite3()) {\n        return {\n          success: true,\n          action: 'install-sqlite',\n          message: 'better-sqlite3 installed successfully',\n          recovered: true\n        };\n      } else {\n        throw new Error('Installation completed but module not found');\n      }\n    },\n    {\n      maxRetries: 3,\n      delay: 2000,\n      onRetry: (attempt, error) => {\n        console.log(`‚ö†Ô∏è  Install attempt ${attempt} failed: ${error.message}`);\n        console.log('üîÑ Cleaning cache and retrying...');\n      }\n    }\n  );\n}\n\n/**\n * Comprehensive error recovery for initialization\n */\nexport async function recoverInitErrors(error: any): Promise<RecoveryResult> {\n  console.log('\\nüö® Error detected during initialization');\n  console.log(`   Error: ${error?.message || String(error)}\\n`);\n\n  // WSL-specific recovery\n  if (isWSL()) {\n    console.log('üîß Applying WSL-specific fixes...');\n    const wslRecovery = await recoverWSLErrors();\n    if (!wslRecovery.success) {\n      return wslRecovery;\n    }\n  }\n\n  // npm cache error recovery\n  if (isNpmCacheError(error)) {\n    console.log('üîß Detected npm cache error, attempting recovery...');\n    const cacheRecovery = await cleanNpmCache();\n    if (!cacheRecovery.success) {\n      return cacheRecovery;\n    }\n\n    // Try to reinstall better-sqlite3\n    if (!await verifyBetterSqlite3()) {\n      console.log('üîß better-sqlite3 missing, attempting reinstall...');\n      return await installBetterSqlite3WithRecovery();\n    }\n\n    return {\n      success: true,\n      action: 'error-recovery',\n      message: 'Cache cleaned and dependencies verified',\n      recovered: true\n    };\n  }\n\n  // Generic error handling\n  return {\n    success: false,\n    action: 'error-recovery',\n    message: `Unable to automatically recover from error: ${error?.message || String(error)}`,\n    recovered: false\n  };\n}\n\n/**\n * Export utility functions\n */\nexport const errorRecovery = {\n  isNpmCacheError,\n  isNativeModuleVersionError,\n  getNativeModuleRecoveryMessage,\n  isWSL,\n  cleanNpmCache,\n  retryWithRecovery,\n  recoverWSLErrors,\n  verifyBetterSqlite3,\n  installBetterSqlite3WithRecovery,\n  recoverInitErrors\n};\n"],"names":["execSync","fs","path","os","isNpmCacheError","error","errorStr","message","String","includes","isNativeModuleVersionError","getNativeModuleRecoveryMessage","compiledMatch","match","requiredMatch","nodeVersionMap","compiled","required","isWSL","process","platform","release","readFileSync","toLowerCase","cleanNpmCache","homeDir","homedir","npxCacheDir","join","console","log","stdio","warn","pathExists","remove","npmDir","success","action","recovered","Error","retryWithRecovery","fn","options","maxRetries","delay","onRetry","cleanupFn","lastError","attempt","recovery","backoffDelay","Math","pow","Promise","resolve","setTimeout","recoverWSLErrors","cwd","startsWith","verifyBetterSqlite3","require","installBetterSqlite3WithRecovery","recoverInitErrors","wslRecovery","cacheRecovery","errorRecovery"],"mappings":"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"}