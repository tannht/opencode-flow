# Dockerfile for testing v2.7.31 - agentic-flow v1.9.4 update
FROM node:20-slim

# Install basic tools and build dependencies for native modules
RUN apt-get update && apt-get install -y \
    git \
    curl \
    jq \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Create test directory
WORKDIR /test

# Copy package files
COPY package.json package-lock.json ./
COPY bin/ ./bin/
COPY src/ ./src/
COPY scripts/ ./scripts/

# Install dependencies (using legacy-peer-deps for test environment)
RUN npm install --legacy-peer-deps

# Create test script
RUN echo '#!/bin/bash' > /test/test-v2.7.31.sh && \
    echo 'set -e' >> /test/test-v2.7.31.sh && \
    echo '' >> /test/test-v2.7.31.sh && \
    echo 'echo "ðŸ§ª Testing claude-flow v2.7.31 - agentic-flow v1.9.4 update"' >> /test/test-v2.7.31.sh && \
    echo 'echo "============================================================="' >> /test/test-v2.7.31.sh && \
    echo '' >> /test/test-v2.7.31.sh && \
    echo '# Test 1: Verify version' >> /test/test-v2.7.31.sh && \
    echo 'echo ""' >> /test/test-v2.7.31.sh && \
    echo 'echo "Test 1: Checking claude-flow version"' >> /test/test-v2.7.31.sh && \
    echo 'VERSION=$(node bin/claude-flow.js --version 2>&1 | grep -o "v[0-9].*")' >> /test/test-v2.7.31.sh && \
    echo 'echo "Claude-Flow Version: $VERSION"' >> /test/test-v2.7.31.sh && \
    echo 'if [ "$VERSION" != "v2.7.31" ]; then' >> /test/test-v2.7.31.sh && \
    echo '  echo "âŒ FAILED: Expected v2.7.31, got $VERSION"' >> /test/test-v2.7.31.sh && \
    echo '  exit 1' >> /test/test-v2.7.31.sh && \
    echo 'else' >> /test/test-v2.7.31.sh && \
    echo '  echo "âœ… PASSED: Claude-Flow version is v2.7.31"' >> /test/test-v2.7.31.sh && \
    echo 'fi' >> /test/test-v2.7.31.sh && \
    echo '' >> /test/test-v2.7.31.sh && \
    echo '# Test 2: Check agentic-flow version in package.json' >> /test/test-v2.7.31.sh && \
    echo 'echo ""' >> /test/test-v2.7.31.sh && \
    echo 'echo "Test 2: Verifying agentic-flow version in package.json"' >> /test/test-v2.7.31.sh && \
    echo 'AGENTIC_FLOW_VERSION=$(cat package.json | jq -r ".dependencies[\"agentic-flow\"]")' >> /test/test-v2.7.31.sh && \
    echo 'echo "agentic-flow version in package.json: $AGENTIC_FLOW_VERSION"' >> /test/test-v2.7.31.sh && \
    echo 'if [ "$AGENTIC_FLOW_VERSION" != "^1.9.4" ]; then' >> /test/test-v2.7.31.sh && \
    echo '  echo "âŒ FAILED: Expected ^1.9.4, got $AGENTIC_FLOW_VERSION"' >> /test/test-v2.7.31.sh && \
    echo '  exit 1' >> /test/test-v2.7.31.sh && \
    echo 'else' >> /test/test-v2.7.31.sh && \
    echo '  echo "âœ… PASSED: agentic-flow is ^1.9.4 in package.json"' >> /test/test-v2.7.31.sh && \
    echo 'fi' >> /test/test-v2.7.31.sh && \
    echo '' >> /test/test-v2.7.31.sh && \
    echo '# Test 3: Verify agentic-flow installed correctly' >> /test/test-v2.7.31.sh && \
    echo 'echo ""' >> /test/test-v2.7.31.sh && \
    echo 'echo "Test 3: Checking agentic-flow installation"' >> /test/test-v2.7.31.sh && \
    echo 'if [ -d "node_modules/agentic-flow" ]; then' >> /test/test-v2.7.31.sh && \
    echo '  INSTALLED_VERSION=$(cat node_modules/agentic-flow/package.json | jq -r ".version")' >> /test/test-v2.7.31.sh && \
    echo '  echo "Installed agentic-flow version: $INSTALLED_VERSION"' >> /test/test-v2.7.31.sh && \
    echo '  if [ "$INSTALLED_VERSION" = "1.9.4" ]; then' >> /test/test-v2.7.31.sh && \
    echo '    echo "âœ… PASSED: agentic-flow 1.9.4 installed"' >> /test/test-v2.7.31.sh && \
    echo '  else' >> /test/test-v2.7.31.sh && \
    echo '    echo "âŒ FAILED: Expected 1.9.4, got $INSTALLED_VERSION"' >> /test/test-v2.7.31.sh && \
    echo '    exit 1' >> /test/test-v2.7.31.sh && \
    echo '  fi' >> /test/test-v2.7.31.sh && \
    echo 'else' >> /test/test-v2.7.31.sh && \
    echo '  echo "âŒ FAILED: agentic-flow not installed"' >> /test/test-v2.7.31.sh && \
    echo '  exit 1' >> /test/test-v2.7.31.sh && \
    echo 'fi' >> /test/test-v2.7.31.sh && \
    echo '' >> /test/test-v2.7.31.sh && \
    echo '# Test 4: Verify agentdb still at 1.6.1' >> /test/test-v2.7.31.sh && \
    echo 'echo ""' >> /test/test-v2.7.31.sh && \
    echo 'echo "Test 4: Checking agentdb version (should still be 1.6.1)"' >> /test/test-v2.7.31.sh && \
    echo 'if [ -d "node_modules/agentdb" ]; then' >> /test/test-v2.7.31.sh && \
    echo '  AGENTDB_VERSION=$(cat node_modules/agentdb/package.json | jq -r ".version")' >> /test/test-v2.7.31.sh && \
    echo '  echo "Installed agentdb version: $AGENTDB_VERSION"' >> /test/test-v2.7.31.sh && \
    echo '  if [[ "$AGENTDB_VERSION" =~ ^1\\.6\\. ]]; then' >> /test/test-v2.7.31.sh && \
    echo '    echo "âœ… PASSED: agentdb 1.6.x still installed (no regression)"' >> /test/test-v2.7.31.sh && \
    echo '  else' >> /test/test-v2.7.31.sh && \
    echo '    echo "âš ï¸  WARNING: agentdb version changed to $AGENTDB_VERSION"' >> /test/test-v2.7.31.sh && \
    echo '  fi' >> /test/test-v2.7.31.sh && \
    echo 'else' >> /test/test-v2.7.31.sh && \
    echo '  echo "âš ï¸  WARNING: agentdb not installed (optional dependency)"' >> /test/test-v2.7.31.sh && \
    echo 'fi' >> /test/test-v2.7.31.sh && \
    echo '' >> /test/test-v2.7.31.sh && \
    echo '# Test 5: Test ReasoningBank initialization' >> /test/test-v2.7.31.sh && \
    echo 'echo ""' >> /test/test-v2.7.31.sh && \
    echo 'echo "Test 5: Testing ReasoningBank initialization"' >> /test/test-v2.7.31.sh && \
    echo 'cat > test-reasoningbank.js << "RBJS"' >> /test/test-v2.7.31.sh && \
    echo 'const RB = require("agentic-flow/reasoningbank");' >> /test/test-v2.7.31.sh && \
    echo 'RB.initialize().then(() => {' >> /test/test-v2.7.31.sh && \
    echo '  console.log("REASONINGBANK_INIT_SUCCESS");' >> /test/test-v2.7.31.sh && \
    echo '  process.exit(0);' >> /test/test-v2.7.31.sh && \
    echo '}).catch(e => {' >> /test/test-v2.7.31.sh && \
    echo '  console.log("REASONINGBANK_INIT_FAILED:", e.message);' >> /test/test-v2.7.31.sh && \
    echo '  process.exit(1);' >> /test/test-v2.7.31.sh && \
    echo '});' >> /test/test-v2.7.31.sh && \
    echo 'RBJS' >> /test/test-v2.7.31.sh && \
    echo 'if timeout 10 node test-reasoningbank.js 2>&1 | grep -q "REASONINGBANK_INIT_SUCCESS"; then' >> /test/test-v2.7.31.sh && \
    echo '  echo "âœ… PASSED: ReasoningBank initialized successfully"' >> /test/test-v2.7.31.sh && \
    echo 'else' >> /test/test-v2.7.31.sh && \
    echo '  echo "âŒ FAILED: ReasoningBank initialization failed"' >> /test/test-v2.7.31.sh && \
    echo '  exit 1' >> /test/test-v2.7.31.sh && \
    echo 'fi' >> /test/test-v2.7.31.sh && \
    echo '' >> /test/test-v2.7.31.sh && \
    echo '# Test 6: Test memory command' >> /test/test-v2.7.31.sh && \
    echo 'echo ""' >> /test/test-v2.7.31.sh && \
    echo 'echo "Test 6: Testing memory stats command"' >> /test/test-v2.7.31.sh && \
    echo 'if timeout 10 node bin/claude-flow.js memory stats >/dev/null 2>&1; then' >> /test/test-v2.7.31.sh && \
    echo '  echo "âœ… PASSED: Memory command works"' >> /test/test-v2.7.31.sh && \
    echo 'else' >> /test/test-v2.7.31.sh && \
    echo '  echo "âŒ FAILED: Memory command failed"' >> /test/test-v2.7.31.sh && \
    echo '  exit 1' >> /test/test-v2.7.31.sh && \
    echo 'fi' >> /test/test-v2.7.31.sh && \
    echo '' >> /test/test-v2.7.31.sh && \
    echo '# Test 7: Verify CLI works' >> /test/test-v2.7.31.sh && \
    echo 'echo ""' >> /test/test-v2.7.31.sh && \
    echo 'echo "Test 7: Testing CLI execution"' >> /test/test-v2.7.31.sh && \
    echo 'if ! node bin/claude-flow.js --help >/dev/null 2>&1; then' >> /test/test-v2.7.31.sh && \
    echo '  echo "âŒ FAILED: CLI --help failed"' >> /test/test-v2.7.31.sh && \
    echo '  exit 1' >> /test/test-v2.7.31.sh && \
    echo 'else' >> /test/test-v2.7.31.sh && \
    echo '  echo "âœ… PASSED: CLI executes successfully"' >> /test/test-v2.7.31.sh && \
    echo 'fi' >> /test/test-v2.7.31.sh && \
    echo '' >> /test/test-v2.7.31.sh && \
    echo '# Test 8: Check for new Supabase dependency' >> /test/test-v2.7.31.sh && \
    echo 'echo ""' >> /test/test-v2.7.31.sh && \
    echo 'echo "Test 8: Checking for new @supabase/supabase-js dependency"' >> /test/test-v2.7.31.sh && \
    echo 'if [ -d "node_modules/@supabase" ]; then' >> /test/test-v2.7.31.sh && \
    echo '  SUPABASE_VERSION=$(cat node_modules/@supabase/supabase-js/package.json 2>/dev/null | jq -r ".version" || echo "N/A")' >> /test/test-v2.7.31.sh && \
    echo '  echo "âœ… PASSED: @supabase/supabase-js available (v$SUPABASE_VERSION) - new in agentic-flow 1.9.4"' >> /test/test-v2.7.31.sh && \
    echo 'else' >> /test/test-v2.7.31.sh && \
    echo '  echo "â„¹ï¸  INFO: @supabase/supabase-js not found (optional cloud feature)"' >> /test/test-v2.7.31.sh && \
    echo 'fi' >> /test/test-v2.7.31.sh && \
    echo '' >> /test/test-v2.7.31.sh && \
    echo 'echo ""' >> /test/test-v2.7.31.sh && \
    echo 'echo "âœ… All tests passed! v2.7.31 is ready for release"' >> /test/test-v2.7.31.sh && \
    chmod +x /test/test-v2.7.31.sh

# Set entrypoint
ENTRYPOINT []
CMD ["/bin/bash", "/test/test-v2.7.31.sh"]
